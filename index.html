<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Preconnect to APIs -->
    <link rel="preconnect" href="https://api.myquran.com" crossorigin>
    <link rel="preconnect" href="https://api.aladhan.com" crossorigin>

    <!-- SEO Meta Tags -->
    <title>Jadwal Sholat Real-time - Waktu Sholat Akurat Berdasarkan Lokasi Anda</title>
    <meta name="description" content="Jadwal waktu sholat real-time dan akurat berdasarkan lokasi Anda. Lihat jam sholat Subuh, Dzuhur, Ashar, Maghrib, dan Isya dengan countdown otomatis. Prayer times Indonesia.">
    <meta name="keywords" content="jadwal sholat, waktu sholat, jam sholat, prayer time, solat time, waktu solat, jam solat, sholat indonesia, jadwal shalat, waktu shalat, jadwal solat, prayer times, islamic prayer times, waktu adzan, jadwal adzan">

    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-emerald-50 via-teal-50 to-cyan-50">
    <div class="max-w-2xl mx-auto p-4 sm:p-6 md:p-8">

        <!-- Header with Clock -->
        <div class="text-center mb-6 sm:mb-8">
            <div class="bg-white rounded-xl sm:rounded-2xl p-4 sm:p-6 shadow-lg border border-emerald-100">
                <div id="date" class="text-slate-600 text-xs sm:text-sm font-medium mb-1"></div>
                <div id="clock" class="text-slate-800 text-3xl sm:text-4xl md:text-5xl font-bold font-mono tracking-wide">--:--:--</div>
                <div id="location" class="mt-2 sm:mt-3 text-emerald-700 font-semibold text-sm sm:text-base"></div>
            </div>
        </div>

        <!-- Countdown Alert -->
        <div id="countdown" class="mb-4 sm:mb-6 bg-emerald-600 text-white rounded-xl sm:rounded-2xl p-4 sm:p-5 shadow-lg text-center hidden">
            <div id="countdown-text" class="text-sm sm:text-base font-medium"></div>
        </div>

        <!-- Loading -->
        <div id="loading" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-10 w-10 sm:h-12 sm:w-12 border-4 border-emerald-200 border-t-emerald-600"></div>
            <div class="text-slate-600 mt-4 font-medium text-sm sm:text-base">Memuat jadwal sholat...</div>
        </div>

        <!-- Error -->
        <div id="error" class="bg-red-50 border border-red-200 p-4 sm:p-6 rounded-xl sm:rounded-2xl text-center shadow-lg hidden">
            <div id="error-text" class="text-red-700 mb-4 font-medium text-sm sm:text-base"></div>
            <button onclick="location.reload()" class="bg-red-600 hover:bg-red-700 text-white px-5 sm:px-6 py-2.5 sm:py-3 rounded-lg sm:rounded-xl font-semibold transition-colors text-sm sm:text-base">
                Coba Lagi
            </button>
        </div>

        <!-- Prayer Times -->
        <div id="prayer-times" class="space-y-2 sm:space-y-3 hidden"></div>

        <!-- Footer -->
        <div class="mt-6 sm:mt-8 text-center text-slate-500 text-xs sm:text-sm">
            <p>Jadwal sholat diperbarui secara otomatis</p>
        </div>
    </div>

    <script>
        // Prayer names mapping
        const prayerNames = {
            imsak: 'Imsak',
            fajr: 'Subuh',
            syuruq: 'Syuruq',
            dhuhr: 'Dzuhur',
            asr: 'Ashar',
            maghrib: 'Maghrib',
            isha: 'Isya'
        };

        const mainPrayers = ['fajr', 'dhuhr', 'asr', 'maghrib', 'isha'];
        const allPrayers = ['imsak', 'fajr', 'syuruq', 'dhuhr', 'asr', 'maghrib', 'isha'];

        let prayerTimesData = null;

        // Update clock
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');

            document.getElementById('clock').textContent = `${hours}:${minutes}:${seconds}`;

            const dateStr = now.toLocaleDateString('id-ID', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            document.getElementById('date').textContent = dateStr;

            // Update countdown
            updateCountdown();
        }

        // Update countdown
        function updateCountdown() {
            if (!prayerTimesData) return;

            const now = new Date();
            const currentMinutes = now.getHours() * 60 + now.getMinutes();

            for (const prayer of mainPrayers) {
                const timeStr = prayerTimesData[prayer];
                const [hours, minutes] = timeStr.split(':').map(Number);
                const prayerMinutes = hours * 60 + minutes;

                let diff = prayerMinutes - currentMinutes;
                if (diff < 0) diff += 24 * 60;

                if (diff > 0 && diff <= 30) {
                    document.getElementById('countdown').classList.remove('hidden');
                    document.getElementById('countdown-text').textContent =
                        `${diff} menit lagi masuk waktu shalat ${prayerNames[prayer]}`;
                    return;
                }
            }

            document.getElementById('countdown').classList.add('hidden');
        }

        // Get location
        async function getLocation() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    reject(new Error('Geolocation tidak didukung browser'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    position => resolve({
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    }),
                    error => reject(new Error('Gagal mendapatkan lokasi. Pastikan GPS aktif.')),
                    { enableHighAccuracy: false, timeout: 5000, maximumAge: 600000 }
                );
            });
        }

        // Get city name
        async function getCityName(lat, lng) {
            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 3000);

                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&addressdetails=1&accept-language=id`,
                    { signal: controller.signal }
                );

                clearTimeout(timeout);

                if (!response.ok) throw new Error('Failed');

                const data = await response.json();
                const addr = data.address || {};

                return addr.city || addr.town || addr.county || addr.state || 'Indonesia';
            } catch (error) {
                return 'Indonesia';
            }
        }

        // Fetch prayer times
        async function fetchPrayerTimes(lat, lng) {
            const date = new Date();
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();

            try {
                // Try MyQuran API first
                const url1 = `https://api.myquran.com/v2/sholat/jadwal/${year}/${month}/${day}/${lat}/${lng}`;
                const res1 = await fetch(url1);
                const data1 = await res1.json();

                if (data1.status && data1.data && data1.data.jadwal) {
                    const j = data1.data.jadwal;
                    return {
                        imsak: j.imsak,
                        fajr: j.subuh,
                        syuruq: j.terbit,
                        dhuhr: j.dzuhur,
                        asr: j.ashar,
                        maghrib: j.maghrib,
                        isha: j.isha
                    };
                }
            } catch (e) {}

            // Fallback to Aladhan
            const dateStr = `${day}-${month}-${year}`;
            const url2 = `https://api.aladhan.com/v1/timings/${dateStr}?latitude=${lat}&longitude=${lng}&method=20`;
            const res2 = await fetch(url2);
            const data2 = await res2.json();
            const t = data2.data.timings;

            return {
                imsak: t.Imsak.substring(0, 5),
                fajr: t.Fajr.substring(0, 5),
                syuruq: t.Sunrise.substring(0, 5),
                dhuhr: t.Dhuhr.substring(0, 5),
                asr: t.Asr.substring(0, 5),
                maghrib: t.Maghrib.substring(0, 5),
                isha: t.Isha.substring(0, 5)
            };
        }

        // Display prayer times
        function displayPrayerTimes(times) {
            const container = document.getElementById('prayer-times');
            container.innerHTML = '';

            allPrayers.forEach(prayer => {
                const isMain = mainPrayers.includes(prayer);
                const div = document.createElement('div');
                div.className = 'bg-white border border-emerald-100 rounded-xl sm:rounded-2xl p-4 sm:p-5 shadow-md hover:shadow-lg transition-shadow';
                div.innerHTML = `
                    <div class="flex items-center justify-between gap-3 sm:gap-4">
                        <span class="font-semibold text-base sm:text-lg md:text-xl ${isMain ? 'text-slate-700' : 'text-slate-500'}">
                            ${prayerNames[prayer]}
                        </span>
                        <span class="font-mono text-xl sm:text-2xl md:text-3xl font-bold text-emerald-700 tracking-wide">
                            ${times[prayer]}
                        </span>
                    </div>
                `;
                container.appendChild(div);
            });

            container.classList.remove('hidden');
        }

        // Initialize app
        async function init() {
            try {
                // Start clock immediately
                updateClock();
                setInterval(updateClock, 1000);

                // Get location
                const { lat, lng } = await getLocation();

                // Get city name (non-blocking)
                getCityName(lat, lng).then(city => {
                    document.getElementById('location').textContent = city;
                });

                // Fetch prayer times
                const times = await fetchPrayerTimes(lat, lng);
                prayerTimesData = times;

                // Display
                displayPrayerTimes(times);

                // Hide loading
                document.getElementById('loading').classList.add('hidden');

            } catch (error) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('error').classList.remove('hidden');
                document.getElementById('error-text').textContent = error.message;
            }
        }

        // Start app
        init();
    </script>
</body>
</html>
